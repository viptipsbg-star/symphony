{% extends "bodybase.html.twig" %}

{% block bodycontainer %}
    <h1>{{ "reports.supervisor_listening.title"|trans }}
        - {{ employee.getFieldValue('name') }} {{ employee.getFieldValue('surname') }}</h1>
    <div class="content-container">
        <div class="body-panel">
            {% if listenings is empty %}
                <h3 class="no-entries">{{ "reports.supervisor_listening.no_entries"|trans }}</h3>
            {% else %}
                <div class="list-table report">
                    <table class="table table-striped table-bordered report-table">
                        <thead>
                        <tr>
                            <th width="200">{{ "reports.supervisor_listening_employee.name"|trans }}</th>
                            <th>{{ "reports.supervisor_listening_employee.started"|trans }}</th>
                            <th>{{ "reports.supervisor_listening_employee.last_listen_date"|trans }}</th>
                            <th>{{ "reports.supervisor_listening_employee.completed"|trans }}</th>
                            <th>{{ "reports.supervisor_listening_employee.course_hours"|trans }}</th>
                            <th>{{ "reports.supervisor_listening_employee.exam_results"|trans }}</th>
                            <th>{{ "reports.supervisor_listening_employee.certificate"|trans }}</th>
                            <th>{{ "reports.supervisor_listening_employee.detail"|trans }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for listening in listenings %}
                            <tr>
                                <td>{{ listening.course.name }}</td>
                                <td>{{ listening.started|date("Y-m-d H:i:s") }}</td>
                                <td>{{ listening.lastListen|date("Y-m-d H:i:s") }}</td>
                                <td>
                                    {% if listening.isCoursePassed %}
                                        <span class="green-boolean"><span class="glyphicon glyphicon-ok"
                                                                          aria-hidden="true"></span></span>
                                    {% else %}
                                        <span class="red-boolean"><span class="glyphicon glyphicon-remove"
                                                                        aria-hidden="true"></span></span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if listening.isCoursePassed %}
                                        {{ listening.course.duration }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if listening.examAttempts is not empty %}
                                        {% for attempt in listening.examAttempts %}
                                            {% if attempt.endtime %}
                                                <span class="exam-attempt {% if attempt.passed %}passed{% elseif attempt.passed == false %}failed{% endif %}">
                                            {{ attempt.starttime|date("Y-m-d") }}
                                                    {% if attempt.result is not empty %}
                                                        - {{ attempt.result }}%
                                                    {% endif %}
                                        </span>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if listening.isCoursePassed() %}
                                        <a href="{{ path("elearning_course_certificate", {listening_id: listening.id}) }}"
                                           target="_blank"><img
                                                    src="{{ asset("bundles/elearningcourses/images/pdf_ico.png") }}"/></a>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ path("elearning_course_report_manager_listening_employee", {listening_id: listening.id}) }}">{{ "reports.supervisor_listening_employee.detail"|trans }}</a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                        <tr class="stacktable-hide">
                            <td colspan="4"></td>
                            <td>{{ completedcoursehours }}</td>
                            <td>{{ "reports.supervisor_listening_employee.average_exam_result"|trans }} {{ avgexamresult|number_format(2) }}
                                %
                            </td>
                            <td colspan="2"></td>
                        </tr>
                        <tr class="stacktable-only mobile-only">
                            <td>{{ "reports.supervisor_listening_employee.completed_course_hours"|trans }} {{ completedcoursehours }}</td>
                            <td>{{ "reports.supervisor_listening_employee.average_exam_result"|trans }} {{ avgexamresult|number_format(2) }}
                                %
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            {% endif %}
            <div class="list-table">
                <table class="table table-bordered manual-hours">
                    <tr>
                        <td width="200">{{ "reports.supervisor_listening_employee.manual_course_hours"|trans }}</td>
                        <td>
                            <span class="hours">{{ manualhours ? manualhours.hours : 0 }}</span>

                            <form class="hours-form form-inline" style="display:none">
                                <div class="form-group">
                                    <input type="text" name="hours" value="{{ manualhours ? manualhours.hours : 0 }}"
                                           class="form-control"/>
                                </div>
                                <div class="form-group">
                                    <input type="hidden" name="employee_id" value="{{ employee.id }}"/>
                                    <button type="submit" class="btn btn-green"><span class="glyphicon glyphicon-ok"
                                                                                      aria-hidden="true"></span>
                                    </button>
                                </div>
                            </form>
                        </td>
                        <td width="50">
                            <a href="#" class="btn btn-green edit-manual-hours"><span class="glyphicon glyphicon-pencil"
                                                                                      aria-hidden="true"></span></a>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

{% endblock %}

{% block stylesheets %}
    {% stylesheets '@ElearningCoursesBundle/Resources/less/styles.less'
    '@ElearningCoursesBundle/Resources/less/responsive.less'
    '../app/Resources/public/css/stacktable.css' filter="cssrewrite" %}
    <link rel="stylesheet" href="{{ asset_url }}">
    {% endstylesheets %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {% javascripts '../app/Resources/public/js/stacktable.js' %}
    <script src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script>
        jQuery(document).ready(function ($) {
            $('table.report-table').stacktable();
            $('.edit-manual-hours').on('click', function (e) {
                e.preventDefault();
                $(this).parents('table').find('form.hours-form').show();
                $(this).parents('table').find('.hours').hide();
            });

            $('.hours-form').submit(function (e) {
                e.preventDefault();
                $.ajax({
                    url: "{{ path("elearning_courses_enter_manual_hours") }}",
                    method: "post",
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            $('.hours-form input[name=hours]').val(response.hours);
                            $('table.manual-hours .hours').html(response.hours).show();
                            $('table.manual-hours form.hours-form').hide();
                        }
                    }
                });
            });
        });
    </script>

{% endblock %}
