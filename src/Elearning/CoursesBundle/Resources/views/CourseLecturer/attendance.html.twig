{% extends "bodybase.html.twig" %}

{% block bodycontainer %}
    <h1>
        {{ "reports.attendance.title"|trans }}
    </h1>
    <div class="content-container">
        <div class="groups-page">
            <div class="groups-list">
                <div class="groups">
                    {% for group in groups %}
                        <div class="group-item managers {% if group.id == currentgroup.id %}current{% endif %}"
                             data-id="{{ group.id }}">
                            <div class="title">{{ group.title }}</div>
                            <div class="count"><span
                                        class="number">{{ group.employees.count }}</span> {{ "groups.group.users"|trans }}
                            </div>
                            <div class="count small no-margin">
                                {% for manager in managers[group.id]%}
                                    {{ manager.getFieldValue("name") }} {{ manager.getFieldValue("surname") }}{% if not loop.last %},{% endif %}
                                {% endfor %}
                            </div>
                            <div class="bottom-options">
                                <a href="{{ path("elearning_courses_report_supervisor_attendance", {'group_id': group.id, 'state' : 'active'}) }}"
                                   class="btn {% if group.id == currentgroup.id and state == 'active' %}btn-disabled{% else %}btn-orange{% endif %} pull-left">{{ "reports.attendance.active"|trans }}</a>
                                <a href="{{ path("elearning_courses_report_supervisor_attendance", {'group_id': group.id, 'state' : 'expelled'}) }}"
                                   class="btn {% if group.id == currentgroup.id and state == 'expelled' %}btn-disabled{% else %}btn-orange{% endif %} pull-right">{{ "reports.attendance.exp"|trans }}</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="assign-course-container">
                <a href="#" class="btn btn-orange add-subject">{{ "reports.attendance.add_subject"|trans }}</a>
                <div class="pull-right">
                    <a href="#" class="btn btn-orange subject-statuses">{{ "reports.attendance.subject_statuses"|trans }}</a>
                    <a href="{{ path("elearning_courses_report_supervisor_attendance", {'group_id': currentgroup.id, 'state': state, 'format': 'excel'}) }}" class="btn btn-orange pull">{{ "reports.attendance.export_excell"|trans }}</a>
                </div>
            </div>

            <div class="group-users">
                <h4>{{ currentgroup.title }}/{% if state == 'active' %}{{ "reports.attendance.active"|trans }}{% else %}{{ "reports.attendance.expelled"|trans }}{% endif %} <span class="pull-right" style="display:none;">{{ "reports.attendance.search"|trans }} <input type="text" id="table-search"></span></h4>
                <div class="table-responsive">
                    <table id="attendance-active" class="cell-border compact stripe">
                        <thead>
                            <tr>
                                <th class="normal">{{ "reports.attendance.subject"|trans }}</th>
                                <th></th>
                                {% for subject in subjects %}
                                    <th contenteditable="true" class="td-editable normal fixed-width" data-id="{{ subject.id }}">{{ subject.description }}</th>
                                {% endfor %}
                            </tr>
                            <tr>
                                <th class="normal">{{ "reports.attendance.name"|trans }}</th>
                                <th></th>
                                {% for subject in subjects %}
                                    <th class="no-sort normal nowrap no-search">
                                        {{ subject.LessonDate | date('Y-m-d') }}
                                        {% if granted %}
                                            <a href="#" class="c-hide pull-right" data-column="{{ loop.index + 1}}" data-url="{{ path('elearning_courses_report_subject_toggle', {'subject_id' : subject.id}) }}"><span class="glyphicon glyphicon-remove text-danger" aria-hidden="true"></span></a>
                                        {% endif %}
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in currentgroupemployees %}
                                <tr>
                                    <td class="name">
                                        <a href="#" class="edit-employee" data-id="{{ employee.id }}">{{ employee.getFieldValue("name") }}&nbsp;{{ employee.getFieldValue("surname") }}</a>&nbsp;
                                    </td>
                                    <td class="nowrap">
                                        <span class="pull-right">
                                            <span class="at-perc">{% if attendance[employee.id] is defined %}{{ attendance[employee.id] }}{{ resultDim }}&nbsp;{% endif %}</span>
                                            {% if diary_enabled %}
                                                <a href="{{ path('elearning_course_supervisor_diary', {'employee_id' : employee.id}) }}" target="_blank"><span class="glyphicon glyphicon-book text-info" aria-hidden="true"></span></a>
                                            {% endif %}
                                            {% if granted %}
                                                <a href="#" class="expell" data-url="{{ path('elearning_courses_report_expell', {'employee_id' : employee.id}) }}"><span class="{% if state == 'active' %}glyphicon glyphicon-minus-sign text-muted{% else %}glyphicon glyphicon-plus-sign text-success{% endif %}" aria-hidden="true"></span></a>
                                            {% endif %}
                                        </span>
                                    </td>
                                    {% for subject in subjects %}
                                        <td>
                                            <select class="at-cell disabled" id="s-{{ employee.id }}-{{ subject.id }}" data-url="{{ path('elearning_courses_report_add_status', {'employee_id' : employee.id, 'subject_id' : subject.id}) }}" {% if not granted %} disabled {% endif %}>
                                                <option value="null" {% if status_table[employee.id ~ '_' ~ subject.id] is not defined %}selected="selected"{% endif %}>
                                                    -
                                                </option>
                                                {% for status in statuses %}
                                                    <option value="{{ status.id }}" {% if status_table[employee.id ~ '_' ~ subject.id] is defined and status_table[employee.id ~ '_' ~ subject.id] == status.id %}selected="selected"{% endif %}>
                                                        {{ status.code }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <span class="glyphicon glyphicon-ok text-success" aria-hidden="true" style="opacity:0;"></span>
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div style="display:none">
            <div id="subject-popup" class="inline-popup">
                {{ form_start(subject_form) }}
                    <div class="form-group">
                        {{ form_label(subject_form.lesson_date) }}
                        {{ form_errors(subject_form.lesson_date) }}
                        {{ form_widget(subject_form.lesson_date, {attr: {'class': 'form-control'}} ) }}
                    </div>
                    <div class="form-group">
                        {{ form_label(subject_form.description) }}
                        {{ form_errors(subject_form.description) }}
                        {{ form_widget(subject_form.description, {attr: {'class': 'form-control'}} ) }}
                    </div>
                    <div class="form-group">
                        <input type="submit" class="btn btn-orange" value="{{ "new_course.editor.create"|trans }}" />
                    </div>
                    {{ form_widget(subject_form.group_id, {attr: {'value': currentgroup.id}} ) }}
                {{ form_end(subject_form) }}
            </div>

            <div id="statuses-popup" class="inline-popup">
                {{ form_start(subject_status_form) }}
                <div class="form-group">
                    {{ form_label(subject_status_form.code) }}
                    {{ form_errors(subject_status_form.code) }}
                    {{ form_widget(subject_status_form.code, {attr: {'class': 'form-control'}} ) }}
                </div>
                <div class="form-group">
                    <input type="submit" class="btn btn-orange" value="{{ "new_course.editor.create"|trans }}" />
                </div>
                {{ form_end(subject_status_form) }}

                <table id="statuses-table" class="table table-bordered table-condensed">
                    <thead>
                        <th>{{ 'reports.attendance.subject_statuses'|trans }}</th>
                    </thead>
                    <tbody>
                        {% for status in statuses %}
                            <tr data-id="{{ status.id }}">
                                <td>{{ status.code }} <a href="" class="remove-status"><span class="glyphicon glyphicon-remove text-danger pull-right" aria-hidden="true"></span></a></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="edit-employee-popup-container" style="display:none">
                <div class="edit-employee-popup popup-content">
                    <form action="#"
                          class="employee_form" method="post">
                        {% form_theme employee_fields_form"bootstrap_3_layout.html.twig" %}
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <b>{% trans %}employees.edit.groups{% endtrans %}:</b> <span id="employee-groups-info"></span>
                                </div>
                                <div class="form-group">
                                    <b>{% trans %}employees.edit.courses{% endtrans %}:</b> <span id="employee-courses-info"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <img id="default-avatar" src="{{ asset('images/avatar.png') }}"/>
                                <img id="avatar" style="display: none;" src=""/>
                            </div>
                        </div>
                        {{ form_widget(employee_fields_form) }}
                        <div class="form-group">
                            <input type="hidden" id="employee_id" name="employee[id]" value=""/>
                            <input type="submit" class="btn btn-orange"
                                   value="{{ "employees.edit.update"|trans }}"/>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {% stylesheets
    '../app/Resources/public/css/magnific-popup.css'
    '@ElearningCompaniesBundle/Resources/less/styles.less'
    'bundles/elearningcompanies/css/chosen.min.css' filter="cssrewrite"
    '@ElearningCompaniesBundle/Resources/less/responsive.less'
    '../app/Resources/public/css/datatables.min.css'
    '../app/Resources/public/css/bootstrap-datepicker.min.css' %}
    <link rel="stylesheet" href="{{ asset_url }}">
    {% endstylesheets %}

{% endblock %}
{% block javascripts %}
    {{ parent() }}
    {% javascripts
    '../app/Resources/public/js/jquery.pajinate.min.js'
    '../app/Resources/public/js/showmessage.js'
    '@ElearningCompaniesBundle/Resources/public/js/chosen.jquery.min.js'
    '../app/Resources/public/js/jquery.magnific-popup.min.js'
    '../app/Resources/public/js/datatables.min.js'
    '../app/Resources/public/js/bootstrap-datepicker.min.js'
    '../app/Resources/public/js/locales/bootstrap-datepicker.lt.min.js' %}
    <script src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', {'callback': 'fos.Router.setData'}) }}"></script>

    <script>

        jQuery.fn.dataTable.Api.register( 'processing()', function ( show ) {
            return this.iterator( 'table', function ( ctx ) {
                ctx.oApi._fnProcessingDisplay( ctx, show );
            } );
        } );

        $(function () {
            $('[data-toggle="popover"]').popover()
        });

        $(function () {

            $('#subject_lesson_date').datepicker({
                format: "yyyy-mm-dd",
                autoclose: "true",
                language: "lt"
            });

            var at_active = $('#attendance-active').DataTable({
                    fixedColumns: {
                        leftColumns: 2
                    },
                    language: {
                        "search": "{{ "reports.attendance.search" | trans }}"
                    },
                    columnDefs: [{
                        "targets": 'no-search',
                        "searchable": false
                    }],
                    scrollY: 400,
                    scrollX: {% if subjects|length > 0 %}'100%'{% else %}false{% endif %},
                    scrollXInner: '101%',
                    scrollCollapse: true,
                    ordering: false,
                    paging: false,
                    lengthChange: false,
                    info: false,
                    searching: true,
                    processing: true
                });

            $('#table-search').keypress(function(){
                if ($(this).val().length >= 3) {
                    at_active.fnFilter($(this).val());
                }
            });

            $('.td-editable').on('blur', function (e) {
                //alert($(this).text());
                var text = $(this).text();
                var subject_id = $(this).attr('data-id');
                $.ajax({
                    type: "POST",
                    url: '{{ path('elearning_courses_report_subject_update') }}',
                    data: { subject_id: subject_id, description: text },
                    dataType: 'json'
                });
            });

            $('.at-cell').on('change', function (e) {
                var icon = $(this).closest('td').find('span');
                $.ajax({
                    url: $(this).attr('data-url') + '/' + $(this).val().toString(),
                    success: function (response) {
                        if (response.success) {
                            $(icon).animate({
                                opacity:"1"
                            }, 100, function() {
                                $(icon).animate({
                                    opacity:"0"
                                }, 1000);
                            });
                        }
                    }
                });
            });

            $('.c-hide').on('click', function (e) {
                e.preventDefault();
                var col = at_active.column($(this).attr('data-column'));

                if (confirm('{{ "reports.attendance.confirm"|trans }}')) {
                    at_active.processing(true);
                    $.ajax({
                        url: $(this).attr('data-url'),
                        success: function (response) {
                            if (response.success) {
                                col.visible(false);
                                at_active.processing(false);
                            } else {
                                at_active.processing(false);
                            }
                        }
                    });
                }
            });

            $('.expell').on('click', function (e) {
                e.preventDefault();
                var row = at_active.row($(this).parents('tr'));
                at_active.processing(true);
                $.ajax({
                    url: $(this).attr('data-url'),
                    success: function (response) {
                        if (response.success) {
                            row.remove().draw();
                            at_active.processing(false);
                        } else {
                            at_active.processing(false);
                        }
                    }
                });
            });

            $('.add-subject').on('click', function (e) {
                e.preventDefault();
                $.magnificPopup.close();
                $.magnificPopup.open({
                    items: {
                        src: "#subject-popup",
                        type: "inline"
                    }
                });
            });

            $('.subject-statuses').on('click', function (e) {
                e.preventDefault();
                $.magnificPopup.open({
                    items: {
                        src: "#statuses-popup",
                        type: "inline"
                    }
                });
            });

            $('.add-status-row').on('click', function (e) {
                e.preventDefault();
                $.magnificPopup.open({
                    items: {
                        src: "#new-status",
                        type: "inline"
                    }
                });
            })


            $('#subject-popup form').submit(function (e) {
                e.preventDefault();
                var form = $(this);

                $.ajax({
                    url: form.attr('action'),
                    method: "post",
                    data: form.serialize(),
                    success: function (response) {
                        if (response.success) {
                            $.magnificPopup.close();
                            location.reload();
                        } else {
                            form.find('#subject_lesson_date').closest('div').addClass('has-error');
                        }
                    }
                });
            });

            $('#statuses-popup form').submit(function (e) {
                e.preventDefault();
                var form = $(this);

                $.ajax({
                    url: form.attr('action'),
                    method: "post",
                    data: form.serialize(),
                    success: function (response) {
                        if (response.success) {
                            $.magnificPopup.close();
                            location.reload();
                        }
                    }
                });
            });

            $('.remove-status').on('click', function (e){
                var row = $(this).closest('tr');
                var status_id = row.attr('data-id');

                $.ajax({
                    type: "POST",
                    url: '{{ path('elearning_courses_report_subject_status_edit') }}',
                    data: { status_id: status_id, action: 'delete' },
                    dataType: 'json',
                    success: function (response) {
                        if (response.success) {
                            $.magnificPopup.close();
                            location.reload();
                        }
                    }
                });

            });

            $('a.edit-employee').on('click', function (e) {
                e.preventDefault();
                var employee_id = $(this).data('id');
                $.ajax({
                    url: Routing.generate("elearning_companies_employees_get_employee", {
                        'employee_id': employee_id
                    }),
                    method: "get",
                    data: {},
                    success: function (response) {
                        if (response.success) {
                            var form = $('.edit-employee-popup form');
                            form.find('.position-select').chosen({
                                width: '100%',
                                create_option: true,
                                persistent_create_option: true,
                                skip_no_results: true,
                                allow_single_deselect: true,
                                placeholder_text: "{{ "new_employee.fields.select_position"|trans }}",
                                create_option_text: "{{ "new_employee.fields.create_new_position"|trans }}"
                            });
                            $.each(response.employee, function (name, value) {
                                var field = form.find("#employee_" + name);
                                if (field.length > 0) {
                                    field.val(value);
                                }
                                if (name == "birthday" && value) {
                                    var parts = value.split(".");
                                    if (parts.length == 1) {
                                        parts = value.split("-");
                                    }
                                    form.find('#employee_' + name + "_year").val(parseInt(parts[0], 10));
                                    form.find('#employee_' + name + "_month").val(parseInt(parts[1], 10));
                                    form.find('#employee_' + name + "_day").val(parseInt(parts[2], 10));
                                }
                                else {
                                    form.find('#employee_' + name + "_year").val("");
                                    form.find('#employee_' + name + "_month").val("");
                                    form.find('#employee_' + name + "_day").val("");
                                }
                                if (name == "position") {
                                    form.find('.position-select').trigger("chosen:updated");
                                }
                                if (name == "groups") {
                                    form.find('#employee-groups-info').text(value.join(', '));
                                }
                                if (name == "courses") {
                                    form.find('#employee-courses-info').text(value.join(', '));
                                }
                                if (name == "image") {
                                    if (value) {
                                        form.find('#avatar').attr('src', value).show();
                                        form.find('#default-avatar').hide();
                                    } else {
                                        form.find('#avatar').hide();
                                        form.find('#default-avatar').show();
                                    }
                                }
                            });
                            form.find('#employee_id').val(employee_id);
                            $.magnificPopup.open({
                                items: {
                                    src: ".edit-employee-popup",
                                    type: "inline"
                                }
                            });
                        }
                    }
                });
            });

            $('.edit-employee-popup form').submit(function (e) {
                e.preventDefault();
                var employee_id = $(this).find('#employee_id').val();
                $.ajax({
                    url: Routing.generate("elearning_companies_employees_update_employee", {
                        'employee_id': employee_id
                    }),
                    method: "post",
                    processData: false,
                    contentType: false,
                    cache: false,
                    data: new FormData(this),
                    success: function (response) {
                        if (response.success) {
                            showmessage("{{ "employees.edit.success"|trans }}", "success")
                            location.reload();
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}


