{% extends "bodybase.html.twig" %}

{% block bodycontainer %}
    <h1>
        {{ "groups.user_groups_title"|trans }}
    </h1>
    <div class="content-container">
        <div class="groups-page">
            <div class="groups-list">
                <div class="add-new-container">
                    <a href="{{ path("elearning_companies_add_new_group") }}"
                       class="btn btn-orange">{{ "groups.list.add_new_group"|trans }}</a>
                </div>
                <div class="groups">
                    {% for group in groups %}
                        <div class="group-item {% if group.id == currentgroup.id %}current{% endif %}"
                             data-id="{{ group.id }}">
                            <a href="#" class="btn btn-green message-group pull-right"
                               data-id="{{ group.id }}"><span
                                        class="glyphicon glyphicon-envelope" aria-hidden="true"></span>
                            </a>
                            <div class="title">{{ group.title }}</div>
                            <div class="count"><span
                                        class="number">{{ group.employees.count }}</span> {{ "groups.group.users"|trans }}
                            </div>
                            <div class="bottom-options">
                                {% if group.id == currentgroup.id %}
                                    <a href="{{ path("elearning_companies_groups", {'group_id': group.id}) }}"
                                       class="btn btn-disabled open-group">{{ "groups.group.open"|trans }}</a>
                                {% else %}
                                    <a href="{{ path("elearning_companies_groups", {'group_id': group.id}) }}"
                                       class="btn btn-orange open-group">{{ "groups.group.open"|trans }}</a>
                                {% endif %}

                                <div class="btn-group pull-right">
                                    <a href="#" class="btn btn-green rename-group">
                                        <span class="glyphicon glyphicon-pencil" aria-hidden="true">
                                        </span>
                                    </a>
                                    <a href="#" class="btn btn-red delete-group">
                                        <span class="glyphicon glyphicon-trash" aria-hidden="true">
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="assign-course-container">
                <a href="#" class="btn btn-orange assign-course">{{ "groups.assign_course"|trans }}</a>
            </div>

            <div class="group-users">

                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#group-employees" aria-controls="group-employees"
                                                              role="tab"
                                                              data-toggle="tab">{{ "groups.tabs.group_employees"|trans }}</a>
                    </li>
                    <li role="presentation"><a href="#group-managers" aria-controls="group-managers" role="tab"
                                               data-toggle="tab">{{ "groups.tabs.group_managers"|trans }}</a></li>
                </ul>


                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane group-employees active" id="group-employees">
                        <div class="group-contents">
                            <h2>{{ currentgroup.title }} - {{ "groups.group_employees.title"|trans }}</h2>
                            <div class="table-header search">
                                <form>
                                    <div class="field-container">
                                        <input type="text" class="keyword" name="search"
                                               placeholder="{{ "groups.all_employees.search_text"|trans }}"/>
                                        <input type="submit" value="" class="search-submit"/>
                                    </div>
                                </form>
                            </div>
                            <table class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th>{{ "groups.employees.name_surname"|trans }}</th>
                                    <th class="hide-mobile">{{ "groups.employees.position"|trans }}</th>
                                    <th class="hide-mobile">{{ "groups.employees.address"|trans }}</th>
                                    <th>{{ "groups.group.employees.delete_from_group"|trans }}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% if currentgroupemployees|length > 0 %}
                                    {% for employee in currentgroupemployees %}
                                        <tr data-id="{{ employee.id }}">
                                            <td class="name">{{ employee.getFieldValue("name") }} {{ employee.getFieldValue("surname") }}</td>
                                            <td class="position hide-mobile">{{ employee.getFieldValue("position") }}</td>
                                            <td class="address hide-mobile">{{ employee.getFieldValue("address") }}</td>
                                            <td><a href="#" class="btn btn-red remove-employee"
                                                   data-id="{{ employee.id }}"><span class="glyphicon glyphicon-trash"
                                                                                     aria-hidden="true"></span></a></td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr class="no-entries-row">
                                        <td colspan="4" class="center">{{ "groups.employees.no_entries"|trans }}</td>
                                    </tr>
                                {% endif %}
                                </tbody>
                            </table>
                            <div class="pagination"></div>
                        </div>

                        <div class="add-to-group-multiple">
                            <h2>{{ "groups.all_employees.add_to_group_multiple_employees"|trans }}</h2>
                            <div class="add-forms row">
                                <div class="col-md-6">
                                    <form action="#" class="multiple-add-by-position multiple-add"
                                          data-field="position">
                                        <div class="form-group">
                                            <label for="by_position">{{ "groups.all_employees.add_to_group_by_position"|trans }}</label>
                                            <select id="by_position" class="form-control">
                                                <option value="0">{{ "groups.all_employees.add_to_group_select_position"|trans }}</option>
                                                {% for position in employeespositions %}
                                                    <option value="{{ position }}">{{ position }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <input type="submit" class="btn btn-orange"
                                                   value="{{ "groups.all_employees.add_to_group_multiple_submit"|trans }}"/>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <form action="#" class=" multiple-add-by-address multiple-add" data-field="address">
                                        <div class="form-group">
                                            <label for="by_address">{{ "groups.all_employees.add_to_group_by_address"|trans }}</label>
                                            <select id="by_address" class="form-control">
                                                <option value="0">{{ "groups.all_employees.add_to_group_select_address"|trans }}</option>
                                                {% for address in employeesaddresses %}
                                                    <option value="{{ address }}">{{ address }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <input type="submit" class="btn btn-orange"
                                                   value="{{ "groups.all_employees.add_to_group_multiple_submit"|trans }}"/>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>


                        <div class="add-to-group">
                            <h2>{{ "groups.all_employees.add_to_group"|trans }}</h2>
                            <div class="table-header search">
                                <form>
                                    <div class="field-container">
                                        <input type="text" class="keyword" name="search"
                                               placeholder="{{ "groups.all_employees.search_text"|trans }}"/>
                                        <input type="submit" value="" class="search-submit"/>
                                    </div>
                                </form>
                            </div>
                            <table class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th>{{ "groups.employees.name_surname"|trans }}</th>
                                    <th class="hide-mobile">{{ "groups.employees.position"|trans }}</th>
                                    <th class="hide-mobile">{{ "groups.employees.address"|trans }}</th>
                                    <th>{{ "groups.group.employees.add_to_group"|trans }}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for employee in employees %}
                                    {% if employee not in currentgroupemployees %}
                                        <tr data-id="{{ employee.id }}">
                                            <td class="name">{{ employee.getFieldValue("name") }} {{ employee.getFieldValue("surname") }}</td>
                                            <td class="position hide-mobile">{{ employee.getFieldValue("position") }}</td>
                                            <td class="address hide-mobile">{{ employee.getFieldValue("address") }}</td>
                                            <td><a href="#" class="btn btn-green add-to-group-btn"
                                                   data-id="{{ employee.id }}"><span
                                                            class="glyphicon glyphicon-ok"
                                                            aria-hidden="true"></span></a></td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                                <tr class="no-entries-row">
                                    <td colspan="4" class="center">{{ "groups.employees.no_entries"|trans }}</td>
                                </tr>
                                </tbody>
                            </table>
                            <div class="pagination"></div>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane group-managers" id="group-managers">
                        <div class="group-contents">
                            <h2>{{ currentgroup.title }} - {{ "groups.group_managers.title"|trans }}</h2>
                            <table class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th>{{ "groups.employees.name_surname"|trans }}</th>
                                    <th class="hide-mobile">{{ "groups.employees.position"|trans }}</th>
                                    <th class="hide-mobile">{{ "groups.employees.address"|trans }}</th>
                                    <th>{{ "groups.group.employees.delete_from_group"|trans }}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% if currentgroupmanagers|length > 0 %}
                                    {% for employee in currentgroupmanagers %}
                                        <tr data-id="{{ employee.id }}">
                                            <td class="name">{{ employee.getFieldValue("name") }} {{ employee.getFieldValue("surname") }}</td>
                                            <td class="position hide-mobile">{{ employee.getFieldValue("position") }}</td>
                                            <td class="address hide-mobile">{{ employee.getFieldValue("address") }}</td>
                                            <td><a href="#" class="btn btn-red remove-employee"
                                                   data-id="{{ employee.id }}"><span class="glyphicon glyphicon-trash"
                                                                                     aria-hidden="true"></span></a></td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr class="no-entries-row">
                                        <td colspan="4" class="center">{{ "groups.employees.no_entries"|trans }}</td>
                                    </tr>
                                {% endif %}
                                </tbody>
                            </table>
                            <div class="pagination"></div>
                        </div>

                        <div class="add-to-group-multiple">
                            <h2>{{ "groups.all_employees.add_to_group_multiple_managers"|trans }}</h2>
                            <div class="add-forms row">
                                <div class="col-md-6">
                                    <form action="#" class="multiple-add-by-position multiple-add"
                                          data-field="position">
                                        <div class="form-group">
                                            <label for="by_position">{{ "groups.all_employees.add_to_group_by_position"|trans }}</label>
                                            <select id="by_position" class="form-control">
                                                <option value="0">{{ "groups.all_employees.add_to_group_select_position"|trans }}</option>
                                                {% for position in managerspositions %}
                                                    <option value="{{ position }}">{{ position }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <input type="submit" class="btn btn-orange"
                                                   value="{{ "groups.all_employees.add_to_group_multiple_submit"|trans }}"/>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <form action="#" class="multiple-add-by-address multiple-add" data-field="address">
                                        <div class="form-group">
                                            <label for="by_address">{{ "groups.all_employees.add_to_group_by_address"|trans }}</label>
                                            <select id="by_address" class="form-control">
                                                <option value="0">{{ "groups.all_employees.add_to_group_select_address"|trans }}</option>
                                                {% for address in managersaddresses %}
                                                    <option value="{{ address }}">{{ address }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <input type="submit" class="btn btn-orange"
                                                   value="{{ "groups.all_employees.add_to_group_multiple_submit"|trans }}"/>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="add-to-group">
                            <h2>{{ "groups.all_managers.add_to_group"|trans }}</h2>
                            <div class="table-header search">
                                <form>
                                    <div class="field-container">
                                        <input type="text" class="keyword" name="search"
                                               placeholder="{{ "groups.all_employees.search_text"|trans }}"/>
                                        <input type="submit" value="" class="search-submit"/>
                                    </div>
                                </form>
                            </div>
                            <table class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th>{{ "groups.employees.name_surname"|trans }}</th>
                                    <th class="hide-mobile">{{ "groups.employees.position"|trans }}</th>
                                    <th class="hide-mobile">{{ "groups.employees.address"|trans }}</th>
                                    <th>{{ "groups.group.employees.add_to_group"|trans }}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for employee in managers %}
                                    {% if employee not in currentgroupmanagers %}
                                        <tr data-id="{{ employee.id }}">
                                            <td class="name">{{ employee.getFieldValue("name") }} {{ employee.getFieldValue("surname") }}</td>
                                            <td class="position hide-mobile">{{ employee.getFieldValue("position") }}</td>
                                            <td class="address hide-mobile">{{ employee.getFieldValue("address") }}</td>
                                            <td><a href="#" class="btn btn-green add-to-group-btn"
                                                   data-id="{{ employee.id }}"><span
                                                            class="glyphicon glyphicon-ok"
                                                            aria-hidden="true"></span></a></td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                                <tr class="no-entries-row">
                                    <td colspan="3" class="center">{{ "groups.employees.no_entries"|trans }}</td>
                                </tr>
                                </tbody>
                            </table>
                            <div class="pagination"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="new-employee">
                <h2>{{ "groups.employees.new.title"|trans }}</h2>
                <div class="alert alert-success message" style="display: none"></div>
                <form action="{{ path("elearning_companies_add_employee") }}"
                      class="employee_form" method="post">
                    {% form_theme employee_fields_form"bootstrap_3_layout.html.twig" %}
                    {{ form_widget(employee_fields_form) }}
                    <div class="form-group">
                        <input type="submit" class="btn btn-orange"
                               value="{{ "groups.employees.new.add"|trans }}"/>
                    </div>
                </form>
            </div>
        </div>
        <div style="display:none">
            <div id="courses-popup" class="popup-content">
                <h2>{{ "groups.courses.popup.title"|trans }}</h2>
                <table class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th>{{ "groups.courses.title"|trans }}</th>
                        <th>{{ "groups.courses.assign"|trans }}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for course in courses %}
                        <tr data-id="{{ course.id }}">
                            <td class="coursename left">{{ course.name }}</td>
                            <td class="assign">
                                {% if course in groupassignedcourses %}
                                    <span class="green-boolean">{{ "groups.courses.assigned"|trans }}</span>
                                    <a href="#" class="course-cancel"
                                       data-id="{{ course.id }}">{{ "groups.courses.cancel"|trans }}</a>
                                {% else %}
                                    <a href="#" class="course-assignment"
                                       data-id="{{ course.id }}">{{ "groups.courses.assign"|trans }}</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <div style="display: none;">
                <div id="message-popup" class="inline-popup">
                    {{ form_start(message_form) }}
                    <div class="form-group">
                        {{ form_label(message_form.subject) }}
                        {{ form_errors(message_form.subject) }}
                        {{ form_widget(message_form.subject, {attr: {'class': 'form-control'}} ) }}
                    </div>
                    <div class="form-group">
                        {{ form_label(message_form.text) }}
                        {{ form_errors(message_form.text) }}
                        {{ form_widget(message_form.text, {attr: {'class': 'form-control'}} ) }}
                    </div>
                    <div class="form-group">
                        <input type="hidden" name="group_id" id="group_id" value=""/>
                        <input type="submit" class="btn btn-orange" value="{{ "employees.send_email.send"|trans }}" />
                    </div>
                    {{ form_end(message_form) }}
                </div>
            </div>

            <div style="display: none;">
                <div id="rename-group-popup" class="inline-popup">
                    {{ form_start(group_title_form) }}
                    <div class="form-group">
                        {{ form_label(group_title_form.title) }}
                        {{ form_errors(group_title_form.title) }}
                        {{ form_widget(group_title_form.title, {attr: {'class': 'form-control'}} ) }}
                    </div>
                    <div class="form-group">
                        <input type="submit" class="btn btn-orange" value="{{ "new_group.rename"|trans }}" />
                    </div>
                    {{ form_end(group_title_form) }}
                </div>
            </div>

            <div class="cancel-course-confirm-popup popup-content">
                <h2>{{ "groups.courses.confirm_popup.do_you_want_to_cancel"|trans }}
                    "%coursename%" {{ "groups.courses.confirm_popup.for_group"|trans }} "%group%"?</h2>
                <div class="button">
                    <a href="#"
                       class="btn btn-orange course-cancel-confirm">{{ "groups.courses.confirm_popup.yes"|trans }}</a>
                    <a href="#"
                       class="btn btn-orange course-cancel-cancel">{{ "groups.courses.confirm_popup.no"|trans }}</a>
                </div>
                <input type="hidden" name="course_id" class="course_id"/>
            </div>

            <div class="assign-course-confirm-popup popup-content">
                <h2>{{ "groups.courses.confirm_popup.do_you_want_to_assign"|trans }}
                    "%coursename%" {{ "groups.courses.confirm_popup.for_group"|trans }} "%group%"?</h2>
                <div class="button">
                    <a href="#"
                       class="btn btn-orange course-assign-confirm">{{ "groups.courses.confirm_popup.yes"|trans }}</a>
                    <a href="#"
                       class="btn btn-orange course-assign-cancel">{{ "groups.courses.confirm_popup.no"|trans }}</a>
                </div>
                <input type="hidden" name="course_id" class="course_id"/>
            </div>

        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {% stylesheets
    '../app/Resources/public/css/magnific-popup.css'
    '@ElearningCompaniesBundle/Resources/less/styles.less'
    'bundles/elearningcompanies/css/chosen.min.css' filter="cssrewrite"
    '@ElearningCompaniesBundle/Resources/less/responsive.less' %}
    <link rel="stylesheet" href="{{ asset_url }}">
    {% endstylesheets %}

{% endblock %}
{% block javascripts %}
    {{ parent() }}
    {% javascripts
    '../app/Resources/public/js/jquery.pajinate.min.js'
    '../app/Resources/public/js/showmessage.js'
    '@ElearningCompaniesBundle/Resources/public/js/chosen.jquery.min.js'
    '../app/Resources/public/js/jquery.magnific-popup.min.js' %}
    <script src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script>
        $(function () {
            function loadEmployee(employee, type) {
                var tabclass = "group-employees";
                if (type == "manager") {
                    tabclass = "group-managers";
                }
                var table = $('.groups-page .' + tabclass + ' .add-to-group table tbody');
                var row = $('<tr data-id="' + employee.id + '"></tr>');
                row.append('<td class="name">' + employee.name + " " + employee.surname + "</td>");
                row.append('<td class="position hide-mobile">' + employee.position + "</td>");
                row.append('<td class="address hide-mobile">' + employee.address + "</td>");
                row.append('<td><a href="#" class="btn btn-green add-to-group-btn" data-id="' + employee.id + '"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></a></td>');
                table.append(row);
            }

            function preparePagination() {
                var pajinateoptions = {
                    items_per_page: 10,
                    item_container_id: "table tbody",
                    nav_panel_id: '.pagination',
                    item_id: 'tr:not(.hidden)',
                    show_first_last: false,
                    abort_on_small_lists: true
                };
                $('.group-users .tab-pane.group-employees > div.group-contents').unbind().pajinate(pajinateoptions);
                $('.group-users .tab-pane.group-employees > div.add-to-group').unbind().pajinate(pajinateoptions);
                $('.group-users .tab-pane.group-managers > div.group-contents').unbind().pajinate(pajinateoptions);
                $('.group-users .tab-pane.group-managers > div.add-to-group').unbind().pajinate(pajinateoptions);
            }

            preparePagination();

            if ($('.add-to-group table tbody tr:not(.no-entries-row)').length > 0) {
                $('.add-to-group table tbody tr.no-entries-row').remove();
            }

            $('a.message-group').on('click', function (e) {
                e.preventDefault();
                var group_id = $(this).data('id');
                $('#message-popup input#group_id').val(group_id);
                $.magnificPopup.open({
                    items: {
                        src: "#message-popup",
                        type: "inline"
                    }
                });
            });

            $('#message-popup form').submit(function(e){
                e.preventDefault();
                var form = $(this);
                form.find('input[type=submit]').prop('disabled', true);
                $.ajax({
                    url: "{{ path("elearning_companies_groups_send_email") }}",
                    data: form.serialize(),
                    method: 'post',
                    success: function(data) {
                        if (data.success) {
                            showmessage(data.message, "success");
                            $.magnificPopup.close();
                        }
                        else {
                            showmessage(data.message, "danger");
                            $.magnificPopup.close();
                        }
                    }
                });
            });

            $('.rename-group').on('click', function (e) {
                e.preventDefault();
                var $group = $(this).parents('.group-item');
                if ($('.groups-page .groups .group-item').length == 1) {
                    return false;
                }
                var group_id = $group.data('id');
                $('#{{ group_title_form.group_id.vars.id }}').val(group_id);
                $.magnificPopup.open({
                    items: {
                        src: "#rename-group-popup",
                        type: "inline"
                    }
                });
            });

            $('form.employee_form').submit(function (e) {
                e.preventDefault();
                var $form = $(this);
                $.ajax({
                    url: $form.attr('action'),
                    method: "post",
                    data: $form.serialize(),
                    success: function (response) {
                        $form.siblings('.message').html(response.message).show();
                        if (response.success) {
                            $form.siblings('.message').removeClass('alert-danger').addClass('alert-success');
                            $form.find('input[type=text]').val("");
                            $form.find('input[type=email]').val("");
                            loadEmployee(response.employee, response.type);
                        }
                        else {
                            $form.siblings('.message').removeClass('alert-success').addClass('alert-danger');
                        }
                    }
                });
            });

            $('.groups-page .search form').submit(function (e) {
                e.preventDefault();
                var keyword = $(this).find('input.keyword').val().toLowerCase();
                var rows = $(this).parents('.table-header').siblings('table').find('tbody tr');
                rows.removeClass("hidden");
                rows.each(function () {
                    if (this.innerText.toLowerCase().indexOf(keyword) == -1) {
                        $(this).addClass('hidden');
                    }
                });
                preparePagination();
            });

            $('.groups-page .groups .group-item .open-group.btn-disabled').on('click', function (e) {
                e.preventDefault();
            });


            $('.groups-page .groups .group-item .delete-group').on('click', function (e) {
                e.preventDefault();
                var $group = $(this).parents('.group-item');
                if ($('.groups-page .groups .group-item').length == 1) {
                    return false;
                }
                var group_id = $group.data('id');
                $.ajax({
                    url: "{{ path("elearning_companies_delete_group") }}",
                    method: "post",
                    data: {
                        id: group_id
                    },
                    success: function (response) {
                        if (response.success) {
                            $group.remove();
                        }
                    }
                });
            });

            function addToGroup(employee_id, row) {
                $.ajax({
                    url: "{{ path("elearning_companies_add_to_group") }}",
                    method: "post",
                    data: {
                        id: employee_id,
                        group_id: {{ currentgroup.id }},
                        new: false
                    },
                    success: function (response) {
                        if (response.success) {
                            var newrow = $('<tr data-id="' + row.data('id') + '"></tr>');
                            newrow.append('<td class="name">' + row.find('td.name').html() + '</td>');
                            newrow.append('<td class="position hide-mobile">' + row.find('td.position').html() + '</td>');
                            newrow.append('<td class="address hide-mobile">' + row.find('td.address').html() + '</td>');
                            newrow.append('<td><a href="#" class="btn btn-red remove-employee" data-id="' + row.data('id') + '"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a></td>');
                            row.parents('.tab-pane').find('.group-contents table tbody .no-entries-row').remove();
                            newrow.appendTo(row.parents('.tab-pane').find('.group-contents table tbody'));

                            var emptytable = row.parents('tbody').children().length === 1;
                            var tbody = row.parents('tbody');
                            row.remove();
                            if (emptytable) {
                                tbody.append('<tr class="no-entries-row"><td colspan="3" class="center">{{ "groups.employees.no_entries"|trans }}</td></tr>');
                            }

                            if (response.newcount) {
                                $('.groups-page .groups .group-item[data-id={{ currentgroup.id }}] .count .number').html(response.newcount);
                            }
                        }
                    }
                });
            }

            $('.groups-page table tbody').on('click', '.add-to-group-btn', function (e) {
                e.preventDefault();
                var employee_id = $(this).data('id');
                var row = $(this).parents('tr');
                addToGroup(employee_id, row);
            });

            $('.groups-page table tbody').on('click', '.remove-employee', function (e) {
                e.preventDefault();
                var employee_id = $(this).data('id');
                var row = $(this).parents('tr');
                $.ajax({
                    url: "{{ path("elearning_companies_remove_from_group") }}",
                    method: "post",
                    data: {
                        id: employee_id,
                        group_id: {{ currentgroup.id }}
                    },
                    success: function (response) {
                        if (response.success) {
                            var newrow = $('<tr data-id="' + employee_id + '"></tr>');
                            newrow.append('<td class="name">' + row.find('td.name').html() + '</td>');
                            newrow.append('<td class="position hide-mobile">' + row.find('td.position').html() + '</td>');
                            newrow.append('<td class="address hide-mobile">' + row.find('td.address').html() + '</td>');
                            newrow.append('<td><a href="#" class="btn btn-green add-to-group-btn" data-id="' + employee_id + '"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></a></td>');
                            row.parents('.tab-pane').find('.add-to-group table tbody .no-entries-row').remove();
                            newrow.appendTo(row.parents('.tab-pane').find('.add-to-group table tbody'));
                            var emptytable = row.parents('tbody').children().length === 1;
                            var tbody = row.parents('tbody');
                            row.remove();
                            if (emptytable) {
                                tbody.append('<tr class="no-entries-row"><td colspan="3" class="center">{{ "groups.employees.no_entries"|trans }}</td></tr>');
                            }
                            if (response.newcount) {
                                $('.groups-page .groups .group-item[data-id={{ currentgroup.id }}] .count .number').html(response.newcount);
                            }
                        }
                    }
                });
            });


            $('.assign-course').on('click', function (e) {
                e.preventDefault();
                $.magnificPopup.open({
                    items: {
                        src: "#courses-popup",
                        type: "inline"
                    }
                });
            });

            $('#courses-popup').on('click', '.course-assignment', function (e) {
                e.preventDefault();
                e.stopPropagation();
                var course_id = $(this).data('id');
                $(".assign-course-confirm-popup input.course_id").val(course_id);
                var coursename = $(this).parents('tr').find('td.coursename').html();
                var groupname = "{{ currentgroup.title }}";
                $(".assign-course-confirm-popup h2").html('{{ "groups.courses.confirm_popup.do_you_want_to_assign"|trans }} "' + coursename + '" {{ "groups.courses.confirm_popup.for_group"|trans }} "' + groupname + '"?');

                var mfp = $.magnificPopup.instance;
                mfp.items[0] = {
                    src: ".assign-course-confirm-popup",
                    type: "inline"
                };
                mfp.updateItemHTML();
            });

            $('.assign-course-confirm-popup .course-assign-confirm').on('click', function (e) {
                e.preventDefault();
                var course_id = $(this).parents('.popup-content').find('input.course_id').val();

                $.ajax({
                    url: "{{ path("elearning_companies_assign_course") }}",
                    method: "post",
                    data: {
                        id: course_id,
                        group_id: {{ currentgroup.id }}
                    },
                    success: function (response) {
                        if (response.success) {
                            showmessage("{{ "groups.course_assign_success"|trans }}", "success")
                            $('#courses-popup table tr[data-id=' + course_id + '] td.assign')
                                    .html('<span class="green-boolean">{{ "groups.courses.assigned"|trans }}</span>'+
                                            '<a href="#" class="course-cancel"'+
                                       'data-id="'+course_id+'">{{ "groups.courses.cancel"|trans }}</a>');
                            $.magnificPopup.close();
                        }
                        else {
                            if (response.message) {
                                showmessage(response.message, "danger");
                            }
                            else {
                                showmessage(response, "danger");
                            }
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        showmessage("ERROR: "+errorThrown, "danger");
                    }
                });
            });

            $('#courses-popup').on('click', '.course-cancel', function (e) {
                e.preventDefault();
                e.stopPropagation();
                var course_id = $(this).data('id');
                $(".cancel-course-confirm-popup input.course_id").val(course_id);
                var coursename = $(this).parents('tr').find('td.coursename').html();
                var groupname = "{{ currentgroup.title }}";
                $(".cancel-course-confirm-popup h2").html('{{ "groups.courses.confirm_popup.do_you_want_to_cancel"|trans }} "' + coursename + '" {{ "groups.courses.confirm_popup.for_group"|trans }} "' + groupname + '"?');

                var mfp = $.magnificPopup.instance;
                mfp.items[0] = {
                    src: ".cancel-course-confirm-popup",
                    type: "inline"
                };
                mfp.updateItemHTML();
            });

            $('.cancel-course-confirm-popup .course-cancel-confirm').on('click', function (e) {
                e.preventDefault();
                var course_id = $(this).parents('.popup-content').find('input.course_id').val();

                $.ajax({
                    url: "{{ path("elearning_companies_cancel_course") }}",
                    method: "post",
                    data: {
                        id: course_id,
                        group_id: {{ currentgroup.id }}
                    },
                    success: function (response) {
                        if (response.success) {
                            showmessage("{{ "groups.course_cancel_success"|trans }}", "success")
                            $('#courses-popup table tr[data-id=' + course_id + '] td.assign')
                                    .html('<a href="#" class="course-assignment" data-id="'+course_id+'">{{  "groups.courses.assign"|trans }}</a>');
                            $.magnificPopup.close();
                        }
                        else {
                            showmessage(response.message, "danger")
                        }
                    }
                });
            });

            $('.assign-course-confirm-popup .course-assign-cancel, .cancel-course-confirm-popup .course-cancel-cancel').on('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                var mfp = $.magnificPopup.instance;
                mfp.items[0] = {
                    src: "#courses-popup",
                    type: "inline"
                };
                mfp.updateItemHTML();
            });

            $('.add-to-group-multiple form.multiple-add').submit(function (e) {
                e.preventDefault();
                var field = $(this).data('field');
                var value = $(this).find('select').val();
                if (value === "0") {
                    return false;
                }
                var type = $(this).parents('.group-employees').length > 0 ? "employees" : "managers";
                var items = $('.tab-pane.group-' + type).find('.add-to-group table tbody tr');
                items.each(function () {
                    if ($(this).find('td.' + field).html() == value) {
                        var employee_id = $(this).data('id');
                        var row = $(this);
                        addToGroup(employee_id, row);
                    }
                });
                $(this).find('select').val("0");
                showmessage('{{ "groups.all_employees.succesfully_added_multiple"|trans }}', 'success');
            });

            $('#employee .position-select').chosen({
                create_option: true,
                persistent_create_option: true,
                skip_no_results: true,
                allow_single_deselect: true,
                placeholder_text: "{{ "new_employee.fields.select_position"|trans }}",
                create_option_text: "{{ "new_employee.fields.create_new_position"|trans }}"
            });
        });
    </script>
{% endblock %}


